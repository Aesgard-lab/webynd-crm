{% extends "backoffice/base.html" %}

{% block page_title %}Ficha de Cliente{% endblock %}

{% block header_right %}
<a href="{% url 'clients' %}" class="text-sm font-medium text-slate-500 hover:text-slate-800 mr-4">
    Volver
</a>
<!-- Acciones -->
<a href="{% url 'client_edit' client.id %}"
    class="bg-white text-slate-500 border border-slate-200 px-4 py-2 rounded-xl text-sm font-medium hover:text-[var(--brand-color)] hover:border-[var(--brand-color)] transition-colors shadow-sm">
    Editar
</a>
<a href="{% url 'pos_home' %}?client_id={{ client.id }}"
    class="bg-[var(--brand-color)] text-white border border-transparent px-4 py-2 rounded-xl text-sm font-bold hover:bg-slate-800 transition-colors shadow-sm flex items-center gap-2">
    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z">
        </path>
    </svg>
    Cobrar
</a>
<button
    class="bg-white text-slate-500 border border-slate-200 px-4 py-2 rounded-xl text-sm font-medium hover:text-[var(--brand-color)] hover:border-[var(--brand-color)] transition-colors shadow-sm">
    Check-in
</button>
{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Columna Izquierda: Perfil -->
    <div class="space-y-6">
        <!-- Card Principal -->
        <div class="bg-white border border-slate-200 rounded-3xl p-6 text-center">
            <div class="relative w-24 h-24 mx-auto mb-4">
                {% if client.photo %}
                <img class="w-full h-full rounded-full object-cover border-4 border-slate-50"
                    src="{{ client.photo.url }}">
                {% else %}
                <div
                    class="w-full h-full rounded-full bg-slate-100 flex items-center justify-center text-slate-400 text-2xl font-bold uppercase border-4 border-slate-50">
                    {{ client.first_name|slice:":2" }}
                </div>
                {% endif %}

                <div class="absolute bottom-0 right-0 w-6 h-6 rounded-full border-4 border-white
                {% if client.status == 'ACTIVE' %}bg-emerald-500
                {% elif client.status == 'INACTIVE' %}bg-slate-400
                {% elif client.status == 'BLOCKED' %}bg-red-500
                {% else %}bg-blue-500{% endif %}">
                </div>
            </div>

            <h2 class="text-xl font-bold text-slate-900">
                <a href="{% url 'client_edit' client.id %}"
                    class="hover:text-[var(--brand-color)] transition-colors inline-flex items-center gap-2 group"
                    title="Editar perfil">
                    {{ client.first_name }} {{ client.last_name }}
                    <svg class="w-4 h-4 text-slate-300 opacity-0 group-hover:opacity-100 transition-opacity" fill="none"
                        viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                    </svg>
                </a>
            </h2>
            <p class="text-sm text-slate-500 mb-4">{{ client.email|default:"Sin email" }}</p>

            <div class="flex flex-wrap gap-2 justify-center mb-6">
                <!-- Groups (Hierarchy) -->
                {% for group in client.groups.all %}
                <span class="text-[10px] px-2 py-0.5 rounded-md border bg-slate-100 text-slate-600 border-slate-200">
                    {{ group }}
                </span>
                {% endfor %}

                <!-- Tags -->
                {% for tag in client.tags.all %}
                <span class="text-[10px] px-2 py-0.5 rounded-md border"
                    style="background-color: {{ tag.color }}10; border-color: {{ tag.color }}30; color: {{ tag.color }}">
                    {{ tag.name }}
                </span>
                {% endfor %}
            </div>

            <div class="border-t border-slate-100 pt-4 text-left space-y-3">
                <div>
                    <span class="text-xs text-slate-400 block uppercase tracking-wide">Tel√©fono</span>
                    <span class="text-sm font-medium text-slate-700">{{ client.phone_number|default:"--" }}</span>
                </div>
                <div>
                    <span class="text-xs text-slate-400 block uppercase tracking-wide">DNI</span>
                    <span class="text-sm font-medium text-slate-700">{{ client.dni|default:"--" }}</span>
                </div>
                <div>
                    <span class="text-xs text-slate-400 block uppercase tracking-wide">Direcci√≥n</span>
                    <span class="text-sm font-medium text-slate-700">{{ client.address|default:"--" }}</span>
                </div>
            </div>
        </div>

        <!-- Notas -->
        <div class="bg-white border border-slate-200 rounded-3xl p-6">
            <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider mb-4">Notas Internas</h3>
            <div class="space-y-4 max-h-80 overflow-y-auto mb-4 pr-1">
                {% for note in notes %}
                <div class="p-3 rounded-xl border relative group
                    {% if note.type == 'VIP' %}bg-amber-50 border-amber-200
                    {% elif note.type == 'WARNING' %}bg-yellow-50 border-yellow-200
                    {% elif note.type == 'DANGER' %}bg-red-50 border-red-200
                    {% else %}bg-slate-50 border-slate-100{% endif %}">

                    <p
                        class="text-sm {% if note.type == 'DANGER' %}text-red-800{% else %}text-slate-600{% endif %} mb-1">
                        {% if note.type == 'VIP' %}‚≠ê {% endif %}
                        {% if note.type == 'DANGER' %}üî• {% endif %}
                        {{ note.text }}
                    </p>
                    <div class="text-xs text-slate-400 flex justify-between items-center mt-2">
                        <span>{{ note.author.first_name|default:"Staff" }} ¬∑ {{ note.created_at|date:"d M" }}</span>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <!-- Edit Action -->
                            <a href="{% url 'client_edit_note' note.id %}"
                                class="text-slate-400 hover:text-[var(--brand-color)] transition-colors" title="Editar">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z">
                                    </path>
                                </svg>
                            </a>
                            <!-- Delete Action -->
                            <form action="{% url 'client_delete_note' note.id %}" method="post"
                                onsubmit="return confirm('¬øBorrar nota?');">
                                {% csrf_token %}
                                <button type="submit" class="text-red-400 hover:text-red-600 transition-colors"
                                    title="Borrar">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                        </path>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-slate-400 text-sm py-4">No hay notas</div>
                {% endfor %}
            </div>

            <!-- Note Form -->
            <form action="{% url 'client_add_note' client.id %}" method="post"
                class="mt-2 pt-2 border-t border-slate-100">
                {% csrf_token %}
                {{ note_form.type }}
                {{ note_form.text }}
                <div class="flex items-center justify-between mt-2">
                    <label class="flex items-center text-xs text-slate-500 gap-2">
                        {{ note_form.is_popup }}
                        Alert Popup
                    </label>
                    <button type="submit"
                        class="bg-white text-slate-500 border border-slate-200 px-3 py-1 rounded-lg text-xs font-medium hover:text-[var(--brand-color)] hover:border-[var(--brand-color)] transition-colors">
                        A√±adir
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Columna Derecha: Historial -->
    <div class="lg:col-span-2 space-y-6">

        <!-- Gesti√≥n Documental -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Documentos y Contratos</h3>
                <!-- Add Document Logic could be a modal, for now inline toggle or similar is simpler, leaving as title action -->
                <button onclick="document.getElementById('add-doc-form').classList.toggle('hidden')"
                    class="text-xs font-medium text-[var(--brand-color)] hover:underline">+ Subir Documento</button>
            </div>

            <!-- Hidden Form -->
            <div id="add-doc-form" class="hidden bg-slate-50 p-4 border-b border-slate-100">
                <form action="{% url 'client_add_document' client.id %}" method="post" enctype="multipart/form-data"
                    class="flex flex-col gap-3">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>{{ document_form.name }}</div>
                        <div>{{ document_form.file }}</div>
                    </div>
                    <div class="flex justify-between items-center">
                        <label class="text-xs text-slate-600 flex items-center gap-2">
                            {{ document_form.is_signed }}
                            ¬øEst√° firmado ya?
                        </label>
                        <button type="submit"
                            class="bg-slate-800 text-white px-3 py-1 rounded-lg text-xs hover:bg-slate-700">Subir</button>
                    </div>
                </form>
            </div>

            <div class="p-0">
                {% if client.documents.exists %}
                <table class="w-full text-sm text-left text-slate-500">
                    <thead class="text-xs text-slate-400 uppercase bg-slate-50">
                        <tr>
                            <th class="px-6 py-3">Documento</th>
                            <th class="px-6 py-3">Estado</th>
                            <th class="px-6 py-3 text-right">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        {% for doc in client.documents.all %}
                        <tr>
                            <td class="px-6 py-3 font-medium text-slate-700">{{ doc.name }}</td>
                            <td class="px-6 py-3">
                                {% if doc.is_signed %}
                                <span class="text-emerald-600 text-xs font-semibold flex items-center gap-1">
                                    ‚úì Firmado
                                    {% if doc.signed_at %}
                                    <span class="text-slate-400 font-normal">({{ doc.signed_at|date:"d/m/y"
                                        }})</span>
                                    {% endif %}
                                </span>
                                {% else %}
                                <span class="text-amber-500 text-xs font-semibold">Pendiente Firma</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-3 text-right">
                                {% if doc.file %}
                                <a href="{{ doc.file.url }}" target="_blank"
                                    class="text-[var(--brand-color)] hover:underline text-xs">Ver PDF</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-6">No hay documentos adjuntos.</p>
                {% endif %}
            </div>
        </section>

        <!-- M√©todos de Pago (Stripe & Redsys) -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="stripeCardHandler()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">M√©todos de Pago</h3>
                <div class="flex gap-2">
                    <!-- Stripe Button -->
                    {% if stripe_public_key %}
                    <button @click="openModal()"
                        class="text-xs font-medium text-[var(--brand-color)] hover:underline flex items-center gap-1">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M13.976 9.15c-2.172-.806-3.356-1.426-3.356-2.409 0-.831.683-1.305 1.901-1.305 2.227 0 4.515.858 6.09 1.631l.89-5.494C18.252.975 15.697 0 12.16 0 9.613 0 7.559.664 6.132 1.943c-1.408 1.259-2.091 2.924-2.091 4.965 0 3.012 1.916 5.093 5.376 6.37 2.457.904 3.065 1.488 3.065 2.505 0 .972-.787 1.572-2.147 1.572-1.957 0-4.632-1.028-6.495-2.067l-.959 5.485c2.022.75 4.881 1.226 7.425 1.226 2.822 0 4.895-.824 6.22-2.225 1.25-1.328 1.838-3.033 1.838-4.992 0-3.321-2.147-5.467-5.399-6.632" />
                        </svg>
                        Stripe
                    </button>
                    {% endif %}

                    <!-- Redsys Button -->
                    {% if redsys_enabled %}
                    <a href="{% url 'redsys_authorize_start' client.id %}"
                        class="text-xs font-medium text-red-600 hover:underline flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                            </path>
                        </svg>
                        Redsys
                    </a>
                    {% endif %}
                </div>
            </div>
            <div class="p-6">
                {% if payment_methods or redsys_tokens %}
                <ul class="space-y-3">
                    <!-- Redsys Tokens -->
                    {% for token in redsys_tokens %}
                    <li class="flex items-center justify-between p-3 border border-red-100 rounded-xl bg-red-50/20">
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-2 rounded-lg border border-red-200 text-red-600">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                            </div>
                            <div>
                                <div class="font-bold text-slate-700 capitalize">
                                    {{ token.card_brand }} <span class="text-slate-400">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{
                                        token.card_number|slice:"-4:" }}</span>
                                    <span class="text-[10px] bg-red-100 text-red-600 px-1 rounded ml-1">Redsys</span>
                                </div>
                                <div class="text-xs text-slate-400">Expira: {{ token.expiration }}</div>
                            </div>
                        </div>
                        <span
                            class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-medium">Guardada</span>
                    </li>
                    {% endfor %}

                    <!-- Stripe Cards -->
                    {% for pm in payment_methods %}
                    <li class="flex items-center justify-between p-3 border border-slate-100 rounded-xl bg-slate-50/50">
                        <div class="flex items-center gap-3">
                            <div class="bg-white p-2 rounded-lg border border-slate-200 text-slate-600">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                        d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                                </svg>
                            </div>
                            <div>
                                <div class="font-bold text-slate-700 capitalize">
                                    {{ pm.card.brand }} <span class="text-slate-400">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ {{ pm.card.last4 }}</span>
                                    <span
                                        class="text-[10px] bg-indigo-100 text-indigo-600 px-1 rounded ml-1">Stripe</span>
                                </div>
                                <div class="text-xs text-slate-400">Expira: {{ pm.card.exp_month }}/{{ pm.card.exp_year
                                    }}</div>
                            </div>
                        </div>
                        <span
                            class="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded-full font-medium">Guardada</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-4">No hay tarjetas vinculadas.</p>
                {% endif %}
            </div>

            <!-- Stripe Modal -->
            <div x-show="isOpen" style="display: none;" class="fixed inset-0 z-50 overflow-y-auto"
                aria-labelledby="modal-title" role="dialog" aria-modal="true">
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"
                        @click="closeModal()"></div>
                    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
                    <div
                        class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4" id="modal-title">Vincular Nueva
                                Tarjeta</h3>

                            <!-- Stripe Element Container -->
                            <div id="payment-element" class="mb-4 min-h-[50px]">
                                <!-- Stripe.js injects the Element here -->
                            </div>

                            <div id="error-message" class="text-red-500 text-sm mb-4 hidden"></div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button @click="confirmSetup()" id="submit-button" type="button"
                                class="w-full inline-flex justify-center rounded-xl border border-transparent shadow-sm px-4 py-2 bg-slate-900 text-base font-medium text-white hover:bg-slate-800 focus:outline-none sm:ml-3 sm:w-auto sm:text-sm">
                                <span x-show="!isLoading">Guardar Tarjeta</span>
                                <span x-show="isLoading">Procesando...</span>
                            </button>
                            <button @click="closeModal()" type="button"
                                class="mt-3 w-full inline-flex justify-center rounded-xl border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <script src="https://js.stripe.com/v3/"></script>
            <script>
                function stripeCardHandler() {
                    return {
                        isOpen: false,
                        isLoading: false,
                        stripe: null,
                        elements: null,
                        clientSecret: null,

                        initStripe() {
                            if (!this.stripe) {
                                this.stripe = Stripe('{{ stripe_public_key }}');
                            }
                        },

                        async openModal() {
                            this.isOpen = true;
                            this.initStripe();

                            // Fetch SetupIntent
                            try {
                                const response = await fetch("{% url 'client_get_stripe_setup' client.id %}");
                                const data = await response.json();

                                if (data.error) {
                                    alert('Error: ' + data.error);
                                    this.isOpen = false;
                                    return;
                                }

                                this.clientSecret = data.client_secret;
                                const appearance = { theme: 'stripe' };
                                this.elements = this.stripe.elements({ clientSecret: this.clientSecret, appearance });
                                const paymentElement = this.elements.create('payment');
                                paymentElement.mount('#payment-element');

                            } catch (e) {
                                console.error(e);
                                alert('Error de conexi√≥n con Stripe');
                            }
                        },

                        closeModal() {
                            this.isOpen = false;
                            this.elements = null;
                            document.getElementById('payment-element').innerHTML = ''; // Clean up
                        },

                        async confirmSetup() {
                            if (this.isLoading) return;
                            this.isLoading = true;
                            document.getElementById('error-message').classList.add('hidden');

                            const { error } = await this.stripe.confirmSetup({
                                elements: this.elements,
                                confirmParams: {
                                    return_url: window.location.href, // Reload page on success (redirect)
                                },
                                redirect: 'if_required'
                            });

                            if (error) {
                                const messageContainer = document.querySelector('#error-message');
                                messageContainer.textContent = error.message;
                                messageContainer.classList.remove('hidden');
                                this.isLoading = false;
                            } else {
                                // Success!
                                window.location.reload();
                            }
                        }
                    }
                }
            </script>
        </section>

        <!-- Suscripciones -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Suscripciones</h3>
                <button class="text-xs font-medium text-[var(--brand-color)] hover:underline">+ Nueva</button>
            </div>
            <div class="p-6">
                {% if memberships %}
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-400 uppercase">
                            <tr>
                                <th class="pb-3">Plan</th>
                                <th class="pb-3">Fechas</th>
                                <th class="pb-3 text-right">Precio</th>
                                <th class="pb-3 text-center">Estado</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            {% for mem in memberships %}
                            <tr>
                                <td class="py-3 font-medium text-slate-800">{{ mem.name }}</td>
                                <td class="py-3">{{ mem.start_date|date:"d/M/y" }} - {{
                                    mem.end_date|date:"d/M/y"|default:"‚àû" }}</td>
                                <td class="py-3 text-right">{{ mem.price }}‚Ç¨</td>
                                <td class="py-3 text-center">
                                    {% if mem.status == 'ACTIVE' %}
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-emerald-100 text-emerald-800">Activa</span>
                                    {% elif mem.status == 'EXPIRED' %}
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-100 text-slate-600">Caducada</span>
                                    {% else %}
                                    <span
                                        class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">{{
                                        mem.get_status_display }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-4">No tiene suscripciones activas ni pasadas.</p>
                {% endif %}
            </div>
        </section>

        <!-- Visitas y Reservas -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Historial de Accesos</h3>
            </div>
            <div class="p-6">
                {% if visits %}
                <div class="space-y-4">
                    {% for visit in visits|slice:":5" %}
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-100 text-slate-500">
                                {% if visit.status == 'SCHEDULED' %}üìÖ{% else %}üìç{% endif %}
                            </div>
                            <div>
                                <div class="text-sm font-medium text-slate-800">{{ visit.concept|default:"Acceso
                                    General" }}</div>
                                <div class="text-xs text-slate-400">{{ visit.date|date:"l d M, Y" }} ¬∑ {{
                                    visit.check_in_time|time:"H:i"|default:"--" }}</div>
                            </div>
                        </div>
                        <div class="text-xs font-medium 
                            {% if visit.status == 'ATTENDED' %}text-emerald-600
                            {% elif visit.status == 'NOSHOW' %}text-red-500
                            {% else %}text-blue-500{% endif %}">
                            {{ visit.get_status_display }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-slate-400 text-sm text-center py-4">Sin registro de visitas todav√≠a.</p>
                {% endif %}
            </div>
        </section>

        <!-- Compras (Orders) - Enhanced with expandable rows -->
        <section class="bg-white border border-slate-200 rounded-3xl overflow-hidden" x-data="purchaseHistory()">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-semibold text-slate-900">Historial de Ventas</h3>
                <a href="{% url 'pos_home' %}?client_id={{ client.id }}"
                    class="text-xs font-medium text-[var(--brand-color)] hover:underline flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Nueva Venta
                </a>
            </div>
            <div class="divide-y divide-slate-100">
                {% if client.orders.exists %}
                {% for order in client.orders.all %}
                <div class="group">
                    <!-- Order Row (Clickable) -->
                    <div @click="toggle({{ order.id }})"
                        class="px-6 py-4 flex justify-between items-center cursor-pointer hover:bg-slate-50 transition-colors">
                        <div class="flex items-center gap-4">
                            <!-- Status Icon -->
                            <div class="w-10 h-10 rounded-xl flex items-center justify-center text-lg
                                    {% if order.status == 'PAID' %}bg-emerald-100 text-emerald-600
                                    {% elif order.status == 'CANCELLED' %}bg-red-100 text-red-500
                                    {% else %}bg-amber-100 text-amber-600{% endif %}">
                                {% if order.status == 'PAID' %}üí∞{% elif order.status == 'CANCELLED' %}‚úï{% else %}‚è≥
                                {% endif %}
                            </div>
                            <div>
                                <div class="font-semibold text-slate-800 flex items-center gap-2">
                                    Ticket #{{ order.id }}
                                    {% if order.invoice_number %}
                                    <span class="text-xs text-slate-400 font-normal">({{ order.invoice_number }})</span>
                                    {% endif %}
                                </div>
                                <div class="text-xs text-slate-400">{{ order.created_at|date:"d M Y ¬∑ H:i" }}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- Status Pill -->
                            <span class="text-[10px] uppercase font-bold tracking-wider px-2 py-1 rounded-full
                                    {% if order.status == 'PAID' %}bg-emerald-100 text-emerald-700
                                    {% elif order.status == 'CANCELLED' %}bg-red-100 text-red-600
                                    {% else %}bg-amber-100 text-amber-700{% endif %}">
                                {{ order.get_status_display }}
                            </span>
                            <!-- Amount -->
                            <div class="text-right min-w-[80px]">
                                <div class="font-bold text-slate-900">{{ order.total_amount }}‚Ç¨</div>
                            </div>
                            <!-- Hover Actions -->
                            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <!-- Send Ticket (Email) -->
                                <button @click.stop="sendTicket({{ order.id }}, '{{ client.email|default:'' }}')"
                                    class="p-2 rounded-lg text-slate-400 hover:text-blue-500 hover:bg-blue-50 transition-colors"
                                    title="Enviar ticket por email">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                                        </path>
                                    </svg>
                                </button>
                                <!-- Edit Order -->
                                <button @click.stop="openEditModal({{ order.id }})"
                                    class="p-2 rounded-lg text-slate-400 hover:text-amber-500 hover:bg-amber-50 transition-colors"
                                    title="Editar venta">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                        </path>
                                    </svg>
                                </button>
                                <!-- Print Ticket -->
                                <button @click.stop="printTicket({{ order.id }})"
                                    class="p-2 rounded-lg text-slate-400 hover:text-[var(--brand-color)] hover:bg-slate-100 transition-colors"
                                    title="Imprimir ticket">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z">
                                        </path>
                                    </svg>
                                </button>
                                <!-- Cancel Order (only if PAID) -->
                                {% if order.status == 'PAID' %}
                                <button @click.stop="confirmCancel({{ order.id }})"
                                    class="p-2 rounded-lg text-slate-400 hover:text-red-500 hover:bg-red-50 transition-colors"
                                    title="Cancelar venta">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                {% endif %}
                                <!-- Expand Indicator -->
                                <svg class="w-4 h-4 text-slate-300 transition-transform ml-1"
                                    :class="{ 'rotate-180': expanded === {{ order.id }} }" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Expanded Details -->
                    <div x-show="expanded === {{ order.id }}" x-collapse
                        class="bg-slate-50 border-t border-slate-100 px-6 py-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Items -->
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Art√≠culos
                                </h4>
                                <ul class="space-y-2">
                                    {% for item in order.items.all %}
                                    <li class="flex justify-between text-sm">
                                        <span class="text-slate-700">
                                            <span class="font-medium">{{ item.quantity }}x</span> {{ item.description }}
                                        </span>
                                        <span class="text-slate-600 font-medium">{{ item.subtotal }}‚Ç¨</span>
                                    </li>
                                    {% empty %}
                                    <li class="text-sm text-slate-400">Sin art√≠culos</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <!-- Payments -->
                            <div>
                                <h4 class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Pagos</h4>
                                <ul class="space-y-2">
                                    {% for payment in order.payments.all %}
                                    <li class="flex justify-between text-sm">
                                        <span class="text-slate-700">{{ payment.payment_method.name }}</span>
                                        <span class="text-slate-600 font-medium">{{ payment.amount }}‚Ç¨</span>
                                    </li>
                                    {% empty %}
                                    <li class="text-sm text-slate-400">Sin pagos registrados</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-slate-400 text-sm text-center py-6">No hay ventas registradas.</p>
                {% endif %}
            </div>

            <!-- Cancel Confirmation Modal -->
            <div x-show="showCancelModal" style="display: none;"
                class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full mx-4 overflow-hidden">
                    <div class="p-6 text-center">
                        <div
                            class="w-12 h-12 rounded-full bg-red-100 text-red-500 mx-auto mb-4 flex items-center justify-center">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
                                </path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-bold text-slate-900 mb-2">¬øCancelar venta?</h3>
                        <p class="text-sm text-slate-500 mb-6">Esta acci√≥n no se puede deshacer. El estado de la venta
                            cambiar√° a "Cancelado".</p>
                        <div class="flex gap-3">
                            <button @click="showCancelModal = false"
                                class="flex-1 px-4 py-2 border border-slate-200 rounded-xl text-slate-600 font-medium hover:bg-slate-50 transition-colors">
                                No, volver
                            </button>
                            <button @click="executeCancel()"
                                class="flex-1 px-4 py-2 bg-red-500 text-white rounded-xl font-medium hover:bg-red-600 transition-colors">
                                S√≠, cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Order Modal -->
            <div x-show="showEditModal" style="display: none;"
                class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm">
                <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4 overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="text-lg font-bold text-slate-900">Editar Venta #<span
                                x-text="editingOrder?.id"></span></h3>
                        <button @click="showEditModal = false" class="text-slate-400 hover:text-slate-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        <!-- Date & Time -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Fecha</label>
                                <input type="date" x-model="editForm.date"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Hora</label>
                                <input type="time" x-model="editForm.time"
                                    class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] focus:border-transparent">
                            </div>
                        </div>
                        <!-- Notes -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Notas internas</label>
                            <textarea x-model="editForm.notes" rows="3"
                                class="w-full px-3 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-[var(--brand-color)] focus:border-transparent resize-none"
                                placeholder="Notas del personal..."></textarea>
                        </div>
                    </div>
                    <div class="px-6 py-4 bg-slate-50 flex gap-3 justify-end">
                        <button @click="showEditModal = false"
                            class="px-4 py-2 border border-slate-200 rounded-xl text-slate-600 font-medium hover:bg-white transition-colors">
                            Cancelar
                        </button>
                        <button @click="saveOrderEdit()" :disabled="isSaving"
                            class="px-4 py-2 bg-[var(--brand-color)] text-white rounded-xl font-medium hover:opacity-90 transition-colors disabled:opacity-50">
                            <span x-show="!isSaving">Guardar</span>
                            <span x-show="isSaving">Guardando...</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <script>
            function purchaseHistory() {
                return {
                    expanded: null,
                    showCancelModal: false,
                    orderToCancel: null,
                    // Edit Modal
                    showEditModal: false,
                    editingOrder: null,
                    editForm: { date: '', time: '', notes: '', payment_method: '' },
                    isSaving: false,

                    toggle(orderId) {
                        this.expanded = this.expanded === orderId ? null : orderId;
                    },

                    confirmCancel(orderId) {
                        this.orderToCancel = orderId;
                        this.showCancelModal = true;
                    },

                    async executeCancel() {
                        if (!this.orderToCancel) return;

                        try {
                            const res = await fetch(`/sales/api/order/${this.orderToCancel}/cancel/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                }
                            });

                            if (res.ok) {
                                window.location.reload();
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Error al cancelar la venta');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n');
                        }

                        this.showCancelModal = false;
                        this.orderToCancel = null;
                    },

                    printTicket(orderId) {
                        window.open(`/sales/ticket/${orderId}/print/`, '_blank');
                    },

                    async sendTicket(orderId, email) {
                        if (!email) {
                            email = prompt('Email del cliente:', '');
                            if (!email) return;
                        }

                        try {
                            const res = await fetch(`/sales/api/order/${orderId}/send-ticket/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({ email })
                            });

                            if (res.ok) {
                                alert('‚úÖ Ticket enviado correctamente a ' + email);
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Error al enviar el ticket');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n');
                        }
                    },

                    async openEditModal(orderId) {
                        try {
                            const res = await fetch(`/sales/api/order/${orderId}/`);
                            if (res.ok) {
                                const order = await res.json();
                                this.editingOrder = order;
                                const dt = new Date(order.created_at);
                                this.editForm = {
                                    date: dt.toISOString().split('T')[0],
                                    time: dt.toTimeString().slice(0, 5),
                                    notes: order.internal_notes || ''
                                };
                                this.showEditModal = true;
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error cargando datos');
                        }
                    },

                    async saveOrderEdit() {
                        if (!this.editingOrder) return;
                        this.isSaving = true;

                        try {
                            const res = await fetch(`/sales/api/order/${this.editingOrder.id}/update/`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({
                                    date: this.editForm.date,
                                    time: this.editForm.time,
                                    internal_notes: this.editForm.notes
                                })
                            });

                            if (res.ok) {
                                window.location.reload();
                            } else {
                                const data = await res.json();
                                alert(data.error || 'Error al guardar');
                            }
                        } catch (e) {
                            console.error(e);
                            alert('Error de conexi√≥n');
                        }

                        this.isSaving = false;
                    }
                }
            }
        </script>

    </div>
</div>
{% endblock %}